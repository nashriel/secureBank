{% extends 'base.html' %}

{% block title %}My Cards | SecureBank{% endblock %}

{% block content %}
<div class="container mt-4">
  <h2 class="mb-4">Hello, {{ username }} ðŸ‘‹</h2>

  <!-- Add Card Button -->
  <button class="btn apple-btn mb-3" data-bs-toggle="modal" data-bs-target="#addCardModal">
    + Add New Card
  </button>

  <div class="row">
    {% for card in cards %}
    <div class="col-md-4 mb-4">
      <div class="flip-card">
        <div class="flip-card-inner" id="cardInner{{ card.id }}">
          <!-- Card Front -->
          <div class="flip-card-front p-3 card-front">
            <div class="d-flex justify-content-between align-items-center">
              <div class="chip3d"></div>
              <div class="apple-logo">ï£¿</div>
            </div>
            <div>
              <p class="fs-5 fw-bold mt-3">{{ card.card_number[:4] }} **** **** {{ card.card_number[-4:] }}</p>
            </div>
            <div class="d-flex justify-content-between">
              <small>Expiry: {{ card.expiry }}</small>
              <small>Status: {% if card.blocked %}<span class="text-danger">Blocked</span>{% else %}<span class="text-success">Active</span>{% endif %}</small>
            </div>
          </div>

          <!-- Card Back -->
          <div class="flip-card-back p-3 card-back">
            <div class="magnetic-strip"></div>
            <div class="mt-3">
              <p class="mb-1"><strong>CVV:</strong> {{ card.cvv }}</p>
              <p class="mb-0"><strong>Account ID:</strong> {{ card.account_id }}</p>
            </div>
            <div class="d-flex justify-content-end mt-auto">
              <div class="apple-logo-small">ï£¿ SecureBank</div>
            </div>
          </div>
        </div>

        <!-- Card Actions -->
        <div class="mt-2 d-flex gap-2 justify-content-between">
          <button class="btn apple-action-btn flex-grow-1" onclick="flipCard('{{ card.id }}')">Flip</button>
          <a href="{{ url_for('main.toggle_card_view', card_id=card.id) }}" class="btn apple-action-btn flex-grow-1">
            {% if card.blocked %}Unblock{% else %}Block{% endif %}
          </a>
          <a href="{{ url_for('main.delete_card_view', card_id=card.id) }}" class="btn apple-action-btn flex-grow-1">Delete</a>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<!-- Add Card Modal -->
<div class="modal fade" id="addCardModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content" style="border-radius:20px; overflow:hidden;">
      <form method="POST" action="{{ url_for('main.add_card_view') }}">
        <div class="modal-header bg-gradient p-3" style="background: linear-gradient(135deg,#f5f5f7,#d1d1d6); border-bottom:none;">
          <h5 class="modal-title fw-bold">Add New Card</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body p-4" style="background:#f5f5f7;">
          <div class="mb-3">
            <label class="form-label fw-semibold">Card Type</label>
            <select class="form-select rounded-pill" name="card_type" required>
              <option value="">Select Type</option>
              <option value="debit">Debit</option>
              <option value="credit">Credit</option>
            </select>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Card Number</label>
            <input type="text" class="form-control rounded-pill shadow-sm" name="card_number" maxlength="16" pattern="\d{16}" placeholder="Enter 16-digit number" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Expiry Date</label>
            <input type="month" class="form-control rounded-pill shadow-sm" name="expiry_date" required>
          </div>
          <div class="mb-3">
            <label class="form-label fw-semibold">Set 4-digit PIN</label>
            <input type="password" class="form-control rounded-pill shadow-sm" name="pin" maxlength="4" pattern="\d{4}" placeholder="****" required>
          </div>
        </div>
        <div class="modal-footer d-flex justify-content-between" style="background:#f5f5f7;">
          <button type="submit" class="btn apple-btn flex-grow-1">Add Card</button>
          <button type="button" class="btn apple-action-btn flex-grow-1" data-bs-dismiss="modal">Cancel</button>
        </div>
      </form>
    </div>
  </div>
</div>

<style>
/* Flip card container */
.flip-card { perspective: 1000px; }
.flip-card-inner { position: relative; width: 100%; height: 200px; transition: transform 0.8s; transform-style: preserve-3d; }
.flip-card-front, .flip-card-back { backface-visibility: hidden; width: 100%; height: 100%; position: absolute; top:0; left:0; border-radius: 20px; box-shadow: 0 10px 20px rgba(0,0,0,0.15); padding: 20px; color: #111; font-family: 'Helvetica Neue', Helvetica, Arial, sans-serif; }
.flip-card-front { background: linear-gradient(135deg,#f5f5f7,#d1d1d6); display:flex; flex-direction:column; justify-content:space-between; }
.flip-card-back { background: linear-gradient(135deg,#d1d1d6,#f5f5f7); transform: rotateY(180deg); display:flex; flex-direction:column; justify-content:space-between; }

/* Apple-style buttons */
.apple-btn { background-color: #0071e3; border: none; color: white; border-radius: 50px; padding: 10px 20px; font-weight: 600; box-shadow: 0 4px 10px rgba(0,0,0,0.2); }
.apple-action-btn { background-color: #f5f5f7; color: #111; border-radius: 25px; border: 1px solid #ccc; padding: 5px 10px; font-weight: 500; transition: all 0.2s; }
.apple-action-btn:hover { background-color: #e1e1e1; }

/* Chip */
.chip3d { width: 50px; height: 35px; border-radius: 8px; background: linear-gradient(145deg, #d1d1d1, #a0a0a0); box-shadow: inset 2px 2px 5px rgba(255,255,255,0.5), inset -2px -2px 5px rgba(0,0,0,0.2); }

/* Magnetic strip for back */
.magnetic-strip { background: #333; height: 40px; border-radius: 5px; }

/* Apple logo */
.apple-logo { font-size: 24px; font-weight: bold; }
.apple-logo-small { font-size: 12px; font-weight: bold; }

/* General styling */
.fs-5 { font-size: 1.25rem; }
.fw-bold { font-weight: 700; }
</style>

<script>
function flipCard(cardId){
  const card = document.getElementById(`cardInner${cardId}`);
  card.style.transform = card.style.transform === "rotateY(180deg)" ? "rotateY(0deg)" : "rotateY(180deg)";
}
</script>
{% endblock %}
