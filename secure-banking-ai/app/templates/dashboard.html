{% extends 'base.html' %}

{% block content %}
<div class="container-fluid">
  <div class="row">
    <div class="col-md-12">
      <h2 class="mb-4">
        {% if is_admin %}
          ðŸ‘‘ Admin Dashboard
        {% else %}
          ðŸ‘¤ {{ username | upper }} Dashboard
        {% endif %}
      </h2>

      <!-- Quick Stats Cards -->
      <div class="row mb-4">
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Total Deposits</h5>
              <p class="card-text">
                {% if not is_admin %}
                  ${{ deposits | sum(attribute='amount') }}
                {% else %}
                  -
                {% endif %}
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Total Withdrawals</h5>
              <p class="card-text">
                {% if not is_admin %}
                  ${{ withdrawals | sum(attribute='amount') }}
                {% else %}
                  -
                {% endif %}
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Current Balance</h5>
              <p class="card-text text-success fw-bold">
                {% if not is_admin %}
                  ${{ balance }}
                {% else %}
                  -
                {% endif %}
              </p>
            </div>
          </div>
        </div>
        <div class="col-md-3">
          <div class="card shadow-sm">
            <div class="card-body">
              <h5 class="card-title">Subscriptions</h5>
              <p class="card-text">
                {% if not is_admin %}
                  {{ subscriptions | length }}
                {% else %}
                  -
                {% endif %}
              </p>
            </div>
          </div>
        </div>
      </div>

      {% if not is_admin %}
      <!-- Regular User Dashboard -->

      <!-- Account Details -->
      <div class="card shadow-sm mb-4">
        <div class="card-header"><h5>Account Details</h5></div>
        <div class="card-body">
          <p><strong>Account Number:</strong> {{ account.account_number }}</p>
          <p><strong>Balance:</strong> ${{ account.balance }}</p>
          <p><strong>Email:</strong> {{ user.email }}</p>
          <p><strong>Fullname:</strong> {{ user.fullname }}</p>
          <p><strong>Username:</strong> {{ user.username }}</p>
        </div>
      </div>

      <!-- Cards -->
      <div class="card shadow-sm mb-4">
        <div class="card-header"><h5>Your Cards</h5></div>
        <div class="card-body">
          {% if cards %}
            <ul>
              {% for card in cards %}
                <li>{{ card.card_type | capitalize }} - {{ card.card_number }} {% if card.blocked %}(Blocked){% endif %}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No cards added yet. <a href="{{ url_for('main.add_card_view') }}">Add a card</a></p>
          {% endif %}
        </div>
      </div>

      <!-- UPI IDs -->
      <div class="card shadow-sm mb-4">
        <div class="card-header"><h5>Your UPI IDs</h5></div>
        <div class="card-body">
          {% if upis %}
            <ul>
              {% for upi in upis %}
                <li>{{ upi.upi_id }}</li>
              {% endfor %}
            </ul>
          {% else %}
            <p>No UPI linked yet.</p>
          {% endif %}
        </div>
      </div>

      <!-- Transactions & Subscriptions Accordion -->
      <div class="accordion mb-4" id="transactionsAccordion">
        <!-- Deposits -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingDeposits">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseDeposits" aria-expanded="false" aria-controls="collapseDeposits">
              ðŸ’µ Deposits ({{ deposits|length }})
            </button>
          </h2>
          <div id="collapseDeposits" class="accordion-collapse collapse" aria-labelledby="headingDeposits" data-bs-parent="#transactionsAccordion">
            <div class="accordion-body">
              {% if deposits %}
              <table class="table table-bordered">
                <thead><tr><th>Txn ID</th><th>Amount</th><th>Date</th><th>Remarks</th></tr></thead>
                <tbody>
                  {% for txn in deposits %}
                  <tr>
                    <td>{{ txn.txn_id }}</td>
                    <td>${{ txn.amount }}</td>
                    <td>{{ txn.date.strftime('%d-%m-%Y %H:%M') }}</td>
                    <td>{{ txn.remarks }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% else %}<p>No deposits yet.</p>{% endif %}
            </div>
          </div>
        </div>

        <!-- Withdrawals -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingWithdrawals">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseWithdrawals" aria-expanded="false" aria-controls="collapseWithdrawals">
              ðŸ’¸ Withdrawals ({{ withdrawals|length }})
            </button>
          </h2>
          <div id="collapseWithdrawals" class="accordion-collapse collapse" aria-labelledby="headingWithdrawals" data-bs-parent="#transactionsAccordion">
            <div class="accordion-body">
              {% if withdrawals %}
              <table class="table table-bordered">
                <thead><tr><th>Txn ID</th><th>Amount</th><th>Date</th><th>Remarks</th></tr></thead>
                <tbody>
                  {% for txn in withdrawals %}
                  <tr>
                    <td>{{ txn.txn_id }}</td>
                    <td>${{ txn.amount }}</td>
                    <td>{{ txn.date.strftime('%d-%m-%Y %H:%M') }}</td>
                    <td>{{ txn.remarks }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% else %}<p>No withdrawals yet.</p>{% endif %}
            </div>
          </div>
        </div>

        <!-- Subscriptions -->
        <div class="accordion-item">
          <h2 class="accordion-header" id="headingSubs">
            <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSubs" aria-expanded="false" aria-controls="collapseSubs">
              ðŸ“… Subscriptions ({{ subscriptions|length }})
            </button>
          </h2>
          <div id="collapseSubs" class="accordion-collapse collapse" aria-labelledby="headingSubs" data-bs-parent="#transactionsAccordion">
            <div class="accordion-body">
              {% if subscriptions %}
              <table class="table table-bordered">
                <thead><tr><th>Name</th><th>Amount</th><th>Frequency</th></tr></thead>
                <tbody>
                  {% for sub in subscriptions %}
                  <tr>
                    <td>{{ sub.name }}</td>
                    <td>${{ sub.amount }}</td>
                    <td>{{ sub.frequency }}</td>
                  </tr>
                  {% endfor %}
                </tbody>
              </table>
              {% else %}<p>No subscriptions yet.</p>{% endif %}
            </div>
          </div>
        </div>

      </div>
      {% endif %}

      <!-- Admin Dashboard: Users Table -->
      {% if is_admin %}
      <div class="card shadow-sm mb-4">
        <div class="card-header"><h5>All Users</h5></div>
        <div class="card-body">
          <table class="table table-bordered table-hover">
            <thead>
              <tr>
                <th>ID</th>
                <th>Fullname</th>
                <th>Email</th>
                <th>Username</th>
                <th>Account Number</th>
                <th>Balance</th>
                <th>Cards</th>
                <th>Subscriptions</th>
                <th>Admin</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              {% for u in all_users %}
              <tr>
                <td>{{ u.id }}</td>
                <td>{{ u.fullname }}</td>
                <td>{{ u.email }}</td>
                <td>{{ u.username }}</td>
                <td>{{ u.account_number }}</td>
                <td>${{ u.balance }}</td>
                <td>{{ u.num_cards }}</td>
                <td>{{ u.num_subscriptions }}</td>
                <td>{{ "Yes" if u.is_admin else "No" }}</td>
                <td>
                  {% if not u.is_admin %}
                    <a href="{{ url_for('main.make_admin_view', user_id=u.id) }}" class="btn btn-sm btn-primary">Make Admin</a>
                  {% endif %}
                  <a href="{{ url_for('main.delete_user_view', user_id=u.id) }}" 
                     class="btn btn-sm btn-danger"
                     onclick="return confirm('Are you sure you want to delete this user?');">
                     Delete
                  </a>
                </td>
              </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
      {% endif %}

    </div>
  </div>
</div>
{% endblock %}
